/* Esbuild-built. Source on GitHub. */
var g=(t,s)=>()=>(s||t((s={exports:{}}).exports,s),s.exports);var b=g((_,v)=>{var C={up:"^",left:"<"},x="m-sheet-cell",W=t=>{t.id=x,t.style.display="none"};v.exports=new class{tableId="m-sheet";isSign=t=>Object.values(C).includes(t);merge=(t,s)=>{if(t.el.id==x)return;let e=1,r;if(t.text==C.left&&t.col>0)r={find:n=>n.row==t.row&&n.col==t.col-e,stop:C.up,type:"colSpan"};else if(t.text==C.up&&t.row>0)r={find:n=>n.row==t.row-e&&n.col==t.col,stop:C.left,type:"rowSpan"};else return;W(t.el);let{find:i,stop:o,type:l}=r,a,u;do{if(a=s.find(i),!a||a.text==o){u=!0;break}e++}while(a.el.id==x);if(u)return;let{el:d}=a;return d[l]||Object.assgin(d,{[l]:1}),d[l]+=1,!0}}});var q=g((te,R)=>{var{isSign:y}=b(),U=t=>{let s=t.receiveCellFocus;t.receiveCellFocus=function(e,r,i,o){if(t.rows[e]?.[r]?.el.style.display=="none"){let{cell:l}=t.editor.tableCell,{row:a,col:u}=t.rows.flat().pop();if(e===l.row){for(;y(t.rows[e]?.[r]?.text);)r+=r<l.col?-1:1;if(r<0)for(;y(t.rows[e]?.[0].text);)e--;r>u&&(r=0,e++,e>a&&t.insertRow(e,r))}else if(r===l.col){for(;y(t.rows[e]?.[r]?.text);)e+=e<l.row?-1:1;if(e<0)for(;y(t.rows[0][r]?.text);)r--}else{if(e===l.row-1)for(;y(t.rows[e][r]?.text);)r--;if(e===l.row+1)for(;y(t.rows[e][r]?.text);)r++}}s.call(this,e,r,i,o)}};R.exports=U});var E=g((re,A)=>{var{merge:$}=b(),J=q(),S=t=>{let s=t.rows.flat();for(let e of s)$(e,s);J(t)},K=t=>t.docView.children.flatMap(s=>s.dom.className.includes("table-widget")?s.widget:[]).map(S);A.exports={mergeTable:S,mergeAllInView:K}});var k=g((se,T)=>{var{tableId:Q,merge:X}=b();T.exports=(t,s)=>class extends s.MarkdownRenderChild{constructor(e,r){super(e),this.buildContGrid(r),this.footMgr.retain(e);let i=e;i.id=Q,this.domGrid=Array.from(i.rows).map((o,l)=>Array.from(o.cells).map((a,u)=>({el:a,row:l,col:u,text:this.contGrid[l][u]}))),this.buildDomTable()}onload(){}onunload(){}cellBorderRE=/(?<!\\)\|/;headerRE=/^\s*?(\:)?(?:-+)(\:)?\s*/;buildContGrid(e){this.contGrid=e.split(`
`).filter(r=>r).map(r=>r.split(this.cellBorderRE).slice(1,-1).map(i=>i.trim())),this.headerRow=this.contGrid.findIndex(r=>r.every(i=>this.headerRE.test(i))),this.contGrid.splice(this.headerRow,1)}buildDomTable(){let e=this.domGrid.flat();for(let r of e)X(r,e)||this.normalizeCell(r)}footMgr=new class{retain=e=>{let r=e.querySelectorAll(".footnote-ref");this.footrefs=Array.from(r).map(i=>({cont:i.children[0].dataset.footref,html:i.outerHTML}))};footRE=/(?<!\\)\[\^(.+?)\]/g;dummy=e=>e.replaceAll(this.footRE,"\u21BF$1\u21BF");restore=e=>e.replaceAll(/↿(.+?)↿/g,(r,i)=>{let o=this.footrefs.find(l=>l.cont===i);return o?o.html:i})};normalizeCell({text:e,el:r}){e=e.replaceAll("<br>",`
`),e=this.footMgr.dummy(e),r.empty(),s.MarkdownRenderer.render(t,e||"\u200B",r,"",this).then(()=>this.afterRender(r))}afterRender=e=>{let r=o=>o.tagName=="P";[e.firstChild,e.lastChild].map(o=>{r(o)&&!o.textContent&&!o.children[0]&&o.remove()});let i="";for(let o of e.childNodes)o.nodeType===3?i+=o.data:i+=r(o)?o.innerHTML:o.outerHTML;i=this.footMgr.restore(i),e.innerHTML=i}}});var G=g((ne,V)=>{V.exports=(t,s)=>{let e=k()(t,s);return postParser=new class{source=[];main=(r,i)=>{if(r.hasClass("block-language-sheet")||!t.workspace.getActiveFileView())return;let l=Array.from(r.querySelectorAll("table"));if(!l[0])return;let a={};l.map(async(u,d)=>{let n,w=i.getSectionInfo(u);if(w){let{text:c,lineStart:h,lineEnd:m}=w,f;a.t==c&&a.s==h&&a.ed==m?f=a.r:f=c.split(`
`).slice(h,m+1).map(D=>P(D)),a.t=c,a.s=h,a.ed=m,F(a,f),n=f.join(`
`),this.source.push(n)}else{await sleep(50);let c=u.offsetParent;if(c?.cmView){let h;if(a.callout===c)h=a.r;else{let m=c.cmView.widget.text;if(!m)return;h=m.split(`
`).map(f=>P(f))}a.callout=c,F(a,h),n=h.join(`
`)}else n=this.source[d]}n&&i.addChild(new e(u,n))})}}};var P=t=>t.replace(/^.*?(?=(?<!\\)\|)/,""),M=(t,s)=>t.findIndex(e=>(s?/^\|/:/^(?!\|)/).test(e)),F=(t,s)=>{if(s[0].startsWith("```"))return;s.splice(0,M(s,!0));let e=M(s);for(;e>-1;)t.r=s.splice(e),e=s[0].startsWith("|")?-1:M(t.r)}});var j=g((I,L)=>{L.exports=(t,s)=>{let e=k()(t,s);return async(r,i,o)=>{await s.MarkdownRenderer.render(t,r,i,"",I);let l=i.querySelector("table");l&&r&&o.addChild(new e(l,r))}}});var O=g((ae,N)=>{var{mergeTable:B,mergeAllInView:H}=E();N.exports=(t,{ob:s,ViewPlugin:e})=>{let r=()=>t.workspace.getActiveFileView()?.editMode;class i{update(n){let w=r();if(!w)return;let{tableCell:c}=w;n.transactions.find(f=>f.isUserEvent("undo"))&&c&&(c.table.render(),B(c.table));let{view:m}=n;(n.focusChanged&&m.hasFocus||n.viewportChanged)&&setTimeout(()=>H(m))}}let o=G()(t,s),l=()=>{o.source=[];let d=r();if(!d)return;let n=d.cm;n&&setTimeout(()=>H(n),50)},a=d=>{let{table:n,cell:w}=d,c=n.rows.flat(),{row:h,col:m,el:f}=w;if(f.rowSpan>1||f.colSpan>1)return c.filter(p=>h<=p.row&&p.row<h+f.rowSpan&&m<=p.col&&p.col<m+f.colSpan).map(p=>{p.el.removeAttribute("id"),p.el.style.display="table-cell"}),f.colSpan=f.rowSpan=1,!0},u=j()(t,s);return function(){this.registerMarkdownPostProcessor(o.main),this.registerMarkdownCodeBlockProcessor("sheet",u),this.registerEvent(t.workspace.on("file-open",l)),t.workspace.onLayoutReady(l),this.addCommand({id:"rebuild",name:"rebuildCurrent",callback:async()=>{o.source=[];let d=r();if(!d)return;let{tableCell:n}=d;if(n)a(n)||B(n.table);else{let w=t.workspace.getLeavesOfType("markdown").filter(c=>c.view.path==d.path);for(let c of w)await c.rebuildView()}},hotkeys:[{modifiers:[],key:"F5"}]}),this.registerEditorExtension([e.fromClass(i)])}}});var z=require("obsidian"),{ViewPlugin:Y}=require("@codemirror/view");module.exports=class extends z.Plugin{onload(){O()(this.app,{ob:z,ViewPlugin:Y}).call(this)}};
